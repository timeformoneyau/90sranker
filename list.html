<!-- ...all your existing head/nav/markup above... -->

  <!-- Firebase & Auth handling -->
  <script type="module" src="auth.js"></script>

  <script type="module">
    import { db } from "./auth.js";
    import {
      collection,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // Personal stats from localStorage
    const stats   = JSON.parse(localStorage.getItem("movieStats")) || {};
    const ratings = JSON.parse(localStorage.getItem("movieRatings")) || {};

    // Render personal top-20
    function renderRankings(globalWinsMap = {}) {
      const topUser = Object.entries(stats).map(([key, r]) => {
        const [title, year] = key.split("|");
        const total = (r.wins||0)+(r.losses||0);
        const pct   = total ? ((r.wins/total)*100).toFixed(1) : "0.0";
        return {
          key,
          label: `${title} (${year})`,
          rating: ratings[key]||1000,
          wins:  r.wins||0,
          losses:r.losses||0,
          winPct: pct,
          isGlobalTop: globalWinsMap[key] !== undefined
        };
      })
      .sort((a,b) => b.rating - a.rating)
      .slice(0,20);

      const tbody = document.getElementById("ranking-list");
      tbody.innerHTML = "";
      topUser.forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.isGlobalTop ? `ðŸ”¥ ${m.label}` : m.label}</td>
          <td>${m.rating}</td>
          <td>${m.wins}</td>
          <td>${m.losses}</td>
          <td>${m.winPct}%</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Aggregate global wins from EVERY vote doc
    async function renderGlobalTop() {
      // pull all vote docs
      const snapshot = await getDocs(collection(db,"votes"));
      const globalWins = {};

      snapshot.forEach(doc => {
        const w = doc.data().winner;
        globalWins[w] = (globalWins[w]||0) + 1;
      });

      // build global top-20
      const sorted = Object.entries(globalWins)
        .sort(([,a],[,b]) => b-a)
        .slice(0,20);

      const glist = document.getElementById("global-list");
      glist.innerHTML = "";
      sorted.forEach(([key, count]) => {
        const [title,year] = key.split("|");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${title} (${year})</td>
          <td>${count}</td>
        `;
        glist.appendChild(tr);
      });

      // then show personal overlay
      renderRankings(globalWins);
    }

    window.onload = () => {
      renderGlobalTop();
    };
  </script>
</body>
</html>
